"use strict";

define(['application-configuration', 'd3','topojson','d3Map','dataFactory','CountryViewScoreData', 'comparatorFactory'], function (app) {

    app.register.controller('mapViewController', ['$document', '$scope','dataFactory','Notify','CountryViewScoreData','comparatorFactory',
        function ($document,$scope,dataFactory,Notify,CountryViewScoreData,comparatorFactory) {

        var countryViewScoreDataCollection = [];
        var selectedServiceAreaId = "";


        initializeCountryViewData();

        $scope.onCountryClick = function(selectedCountry)
        {
            var selectedCountryViewScoreData = _.find(countryViewScoreDataCollection, function(n){
                return n.CountryKey == selectedCountry.properties.NAME;
            });
            if(selectedCountryViewScoreData){
                //Popup scorecard stuff goes here
                window.alert(selectedCountryViewScoreData.DisplayName);
            }

        };
        $scope.$on(Notify.SERVICE_AREA_CHANGED, function () {
            selectedServiceAreaId = dataFactory.SelectedServiceAreaId();
            updateSelectedServiceAreaScoreData();
            $scope.d3ServiceId = selectedServiceAreaId;
        });
        $scope.$on(Notify.DATASET_CHANGED, function () {
            initializeCountryViewData();
        });

        $scope.$on(Notify.COMPARATOR_TYPE_CHANGED, function () {
            updateSelectedServiceAreaScoreData();
            $scope.d3Data = countryViewScoreDataCollection;
            //TODO: adding time stamp to create unique service area id so the it triggered map transition
            //Need to find out proper way for this
            $scope.d3ServiceId = selectedServiceAreaId + new Date().getTime().toString();
        });
            $scope.$on(Notify.COMPARATOR_COLOR_CHANGED, function () {
                updateSelectedServiceAreaScoreData();
                $scope.d3Data = countryViewScoreDataCollection;
                $scope.d3ServiceId = selectedServiceAreaId + new Date().getTime().toString();
            });

        //Private Methods
        function initializeCountryViewData(){
            selectedServiceAreaId = dataFactory.SelectedServiceAreaId();
            prepareCountryViewDataCollection(dataFactory.CountryaScoreDataCollection());
            updateSelectedServiceAreaScoreData();
            $scope.d3Data = countryViewScoreDataCollection;
            $scope.d3ServiceId = selectedServiceAreaId;
        }

        function prepareCountryViewDataCollection(cCollection){
            for ( var i=0; i<cCollection.length; i++){
                var viewData = new CountryViewScoreData();
                viewData.CountryKey = cCollection[i].Country.Countrykey;
                viewData.DisplayName = cCollection[i].Country.Displayname;
                viewData.Score = NaN;
                viewData.Comparator = NaN;
                viewData.CountryColor = "#736F6E";
                viewData.MappedCountryValues = cCollection[i].Country.MappedCountryValues;
                viewData.ServiceAreaScoreDataCollection = cCollection[i].ServiceAreaScoreDataCollection;

                countryViewScoreDataCollection.push(viewData);
            }
        }

        function updateSelectedServiceAreaScoreData(){
            for (var i=0; i<countryViewScoreDataCollection.length; i++){
                var countryData = countryViewScoreDataCollection[i];
                if(countryData.ServiceAreaScoreDataCollection && countryData.ServiceAreaScoreDataCollection.length > 0){
                    var selectedScoreItems = _.filter(countryData.ServiceAreaScoreDataCollection, function(n){
                        return n.Id == selectedServiceAreaId
                    });
                    if(selectedScoreItems.length > 0){
                        countryData.Score = selectedScoreItems[0].Score;
                        countryData.Comparator = comparatorFactory.GetScoreItemComparator(selectedServiceAreaId);
                        if(!isNaN(countryData.Score)){
                            countryData.CountryColor = dataFactory.GetScoreColor(countryData.Score, countryData.Comparator);
                        }

                    }
                }
            }
        }

    }]);

});
